(function(a,b){'object'==typeof exports&&'undefined'!=typeof module?module.exports=b():'function'==typeof define&&define.amd?define(b):a.Realm=b()})(this,function(){'use strict';function a(a,b){const{unsafeEval:c}=a;return c(D)(b)}function b(a,b=void 0){const c=`please report internal shim error: ${a}`;console.error(c),b&&(console.error(`${b}`),console.error(`${b.stack}`));debugger;throw c}function c(a,c){a||b(c)}function d(a){const b={Infinity:{value:1/0},NaN:{value:NaN},undefined:{value:void 0}};for(const d of Y){const e=J(a,d);e&&(c('value'in e,`unexpected accessor on global property: ${d}`),b[d]={value:e.value,writable:!0,configurable:!0})}return b}function e(){function a(a){if(void 0===a||null===a)throw new TypeError(`can't convert undefined or null to object`);return Object(a)}function b(a){return'symbol'==typeof a?a:`${a}`}function c(a,b){if('function'!=typeof a)throw TypeError(`invalid ${b} usage`);return a}const{defineProperty:d,defineProperties:e,getOwnPropertyDescriptor:f,getPrototypeOf:g,prototype:h}=Object;try{h.__lookupGetter__('dummy')}catch(a){return}e(h,{__defineGetter__:{value:function(b,e){const f=a(this);d(f,b,{get:c(e,'getter'),enumerable:!0,configurable:!0})}},__defineSetter__:{value:function(b,e){const f=a(this);d(f,b,{set:c(e,'setter'),enumerable:!0,configurable:!0})}},__lookupGetter__:{value:function(c){let d=a(this);c=b(c);let e;for(;d&&!(e=f(d,c));)d=g(d);return e&&e.get}},__lookupSetter__:{value:function(c){let d=a(this);c=b(c);let e;for(;d&&!(e=f(d,c));)d=g(d);return e&&e.set}}})}function f(){function a(a,e){let f;try{f=(0,eval)(e)}catch(a){if(a instanceof SyntaxError)return;throw a}const g=c(f),h=Function('throw new TypeError("Not available");');b(h,'name',{value:a}),b(g,'constructor',{value:h}),b(h,'prototype',{value:g}),h!==Function.prototype.constructor&&d(h,Function.prototype.constructor)}const{defineProperty:b,getPrototypeOf:c,setPrototypeOf:d}=Object;a('Function','(function(){})'),a('GeneratorFunction','(function*(){})'),a('AsyncFunction','(async function(){})'),a('AsyncGeneratorFunction','(async function*(){})')}function g(a,b){const c=d(a);return I({unsafeGlobal:a,sharedGlobalDescs:c,unsafeEval:a.eval,unsafeFunction:a.Function,allShims:b})}function h(a){return a}function i(a){const b=ba();return b.eval(ca),b.eval(da),g(b,a)}function j(a){const b=K(a),c=S(L(b),a=>{if('eval'===a||fa.has(a)||!W(ea,a))return!1;const c=b[a];return!1===c.configurable&&!1===c.writable&&R(c,'value')});return c}function k(a){const{unsafeGlobal:b,unsafeEval:c}=a;let d,e=!1;return{__proto__:ga,allowUnsafeEvaluatorOnce(){e=!0},unsafeEvaluatorAllowed(){return e},getScopedEvaluatorMemo(){return d},memoScopedEvaluator(a){d=a},get(a,b){if('eval'===b)return!0==e?(e=!1,c):a.eval;if(b!==Symbol.unscopables&&b in a){const c=J(M(a),b);return c&&!1===c.writable&&!1===c.configurable&&(d=void 0),a[b]}},set(a,b,c){if(R(a,b))throw new TypeError(`do not modify endowments like ${b+''}`);return M(a)[b]=c,!0},has(a,c){return!!('eval'===c||c in a||c in b)}}}function l(a){const b=ha.exec(a);if(b){const a=b[1].split('\n').length;throw new SyntaxError(`possible import expression rejected around line ${a}`)}}function m(a){return 0===a.length?'':`const {${U(a,',')}} = this;`}function n(a,b){const{unsafeFunction:c}=a,d=m(b);return c(`
    with (arguments[0]) {
      ${d}
      return function() {
        'use strict';
        return eval(arguments[0]);
      };
    }
  `)}function o(a,d){const{unsafeFunction:e}=a,f=k(a);return function(g={}){const h={eval(c){let e=f.getScopedEvaluatorMemo();if(void 0===e){const b=j(d),c=n(a,b),h=F(d,K(g)),i=new Proxy(h,f);e=O(c,d,[i]),1<=b.length&&f.memoScopedEvaluator(e)}c=`${c}`,l(c),f.allowUnsafeEvaluatorOnce();let h;try{return O(e,d,[c])}catch(a){throw h=a,a}finally{f.unsafeEvaluatorAllowed()&&b('handler did not revoke useUnsafeEvaluator',h)}}}.eval;return N(h,e.prototype),c(M(h).constructor!==Function,'hide Function'),c(M(h).constructor!==e,'hide unsafeFunction'),H(h,'toString',{value:h('() => \'function eval() { [shim code] }\''),writable:!1,enumerable:!1,configurable:!0}),h}}function p(a){return a()}function q(a){return(b,c)=>a(c)(b)}function r(a,b){const{unsafeFunction:d,unsafeGlobal:e}=a,f=function(...a){const c=`${T(a)||''}`;let f=`${U(a,',')}`;if(new d(c),X(f,')'))throw new e.SyntaxError('shim limitation: Function arg string contains parenthesis');0<f.length&&(f+='\n/*``*/');const g=`(function(${f}){\n${c}\n})`;return b(g)};return N(f,d.prototype),c(M(f).constructor!==Function,'hide Function'),c(M(f).constructor!==d,'hide unsafeFunction'),H(f,'prototype',{value:d.prototype}),H(f,'toString',{value:b('() => \'function Function() { [shim code] }\''),writable:!1,enumerable:!1,configurable:!0}),f}function s(a){if(Object(a)!==a)throw new TypeError('internal error: bad object, not a Realm constructor');if(!ia.has(a))throw new TypeError('internal error: bad object');return ia.get(a)}function t(a,b){if(Object(a)!==a)throw new TypeError('internal error: bad object, not a Realm constructor');if(ia.has(a))throw new TypeError('internal error: bad object');ia.set(a,b)}function u(a){if(Object(a)!==a)throw new TypeError('bad object, not a Realm instance');if(!ja.has(a))throw new TypeError('bad object, use Realm.makeRootRealm() or .makeCompartment() instead of "new Realm"');return ja.get(a)}function v(a,b){if(Object(a)!==a)throw new TypeError('internal error: bad object, not a Realm instance');if(ja.has(a))throw new TypeError('internal error: Realm instance is already present');ja.set(a,b)}function w(a,b,c,d){G(b,a),H(b,'eval',{value:c,writable:!0,configurable:!0}),H(b,'Function',{value:d,writable:!0,configurable:!0})}function x(a){const{sharedGlobalDescs:b,unsafeGlobal:c}=a,d=F(c.Object.prototype),e=o(a,d),f=p(e),g=q(e),h=r(a,f);w(b,d,f,h);const i=I({safeGlobal:d,safeEval:f,safeEvalWhichTakesEndowments:g,safeFunction:h});return i}function y(a,b,c){c=Object(c);const d=c.shims||[],{allShims:e}=s(a),f=V(e,d),g=i(f),h=C(g);t(h,g);const j=x(g);v(b,j);for(const d of f)B(b,d)}function z(a,b){const c=s(a),d=x(c);v(b,d)}function A(a){const{safeGlobal:b}=u(a);return b}function B(a,b,c={}){const{safeEvalWhichTakesEndowments:d}=u(a);return d(b,c)}function C(b){const c=a(b,{initRootRealm:y,initCompartment:z,getRealmGlobal:A,realmEvaluate:B});return b.sharedGlobalDescs.Realm={value:c,writable:!0,configurable:!0},c}const D=`'use strict'; (${function({initRootRealm:a,initCompartment:b,getRealmGlobal:c,realmEvaluate:d}){function e(a,...b){try{return a(...b)}catch(a){if(Object(a)!==a)throw a;let b,c,d;try{b=`${a.name}`,c=`${a.message}`,d=`${a.stack}`}catch(a){throw new Error('unknown error')}const e=g.get(b)||Error;try{throw new e(c)}catch(a){throw a.stack=d,a}}}const{defineProperty:f}=Object,g=new Map([['EvalError',EvalError],['RangeError',RangeError],['ReferenceError',ReferenceError],['SyntaxError',SyntaxError],['TypeError',TypeError],['URIError',URIError]]);class h{static makeRootRealm(...b){const c=new h;return e(a,h,c,...b),c}static makeCompartment(...a){const c=new h;return e(b,h,c,...a),c}get global(){return e(c,this)}evaluate(...a){return e(d,this,...a)}}return f(h.prototype,'toString',{value:()=>'function Realm() { [shim code] }',writable:!1,enumerable:!1,configurable:!0}),h}})`,{assign:E,create:F,defineProperties:G,defineProperty:H,freeze:I,getOwnPropertyDescriptor:J,getOwnPropertyDescriptors:K,getOwnPropertyNames:L,getPrototypeOf:M,setPrototypeOf:N}=Object,{apply:O,ownKeys:P}=Reflect,Q=a=>(b,...c)=>O(a,b,c),R=Q(Object.prototype.hasOwnProperty),S=Q(Array.prototype.filter),T=Q(Array.prototype.pop),U=Q(Array.prototype.join),V=Q(Array.prototype.concat),W=Q(RegExp.prototype.test),X=Q(String.prototype.includes),Y=['isFinite','isNaN','parseFloat','parseInt','decodeURI','decodeURIComponent','encodeURI','encodeURIComponent','Array','ArrayBuffer','Boolean','DataView','Date','Error','EvalError','Float32Array','Float64Array','Int8Array','Int16Array','Int32Array','Map','Number','Object','Promise','Proxy','RangeError','ReferenceError','RegExp','Set','String','Symbol','SyntaxError','TypeError','Uint8Array','Uint8ClampedArray','Uint16Array','Uint32Array','URIError','WeakMap','WeakSet','JSON','Math','Reflect','escape','unescape','Intl'],Z='object'==typeof exports&&'undefined'!=typeof module,$='object'==typeof document;if(!Z&&!$||Z&&$)throw new Error('unexpected platform, unable to create Realm');const _=Z?require('vm'):void 0,aa=`(0, eval)("'use strict'; this")`,ba=Z?function(){const a=_.runInNewContext('(0, eval)("\'use strict\'; this")');return a}:function(){const a=document.createElement('iframe');a.style.display='none',document.body.appendChild(a);const b=a.contentWindow.eval('\'use strict\'; this');return b},ca=h(`"use strict"; (${e})();`),da=h(`"use strict"; (${f})();`),ea=/^[a-zA-Z_$][\w$]*$/,fa=new Set(['await','break','case','catch','class','const','continue','debugger','default','delete','do','else','export','extends','finally','for','function','if','import','in','instanceof','new','return','super','switch','this','throw','try','typeof','var','void','while','with','yield','enum','implements','package','protected','interface','private','public','let','async','arguments']),ga=new Proxy(I({}),{get(a,c){b(`unexpected scope handler trap called: ${c}`)}}),ha=/^(.*)\bimport\s*(\(|\/\/|\/\*)/m,ia=new WeakMap,ja=new WeakMap,ka=function(){const a=(0,eval)('\'use strict\'; this');return e(),f(),g(a,[])}(),la=a(ka,{initRootRealm:y,initCompartment:z,getRealmGlobal:A,realmEvaluate:B});return t(la,ka),la});
//# sourceMappingURL=realm-shim.min.js.map
